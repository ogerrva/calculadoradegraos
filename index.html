<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Calculadora de Romaneio de Gr√£os Offline">
    <title>Calculadora de Gr√£os</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="img/logo.png" type="image/png">
    <link rel="apple-touch-icon" href="img/logo.png">

    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #f1f8e9;
            --dark: #1b5e20;
            --text: #333;
            --card-bg: #ffffff;
            --danger: #d32f2f;
            --info: #0288d1;
            --border: #ccc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e8f5e9;
            color: var(--text);
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
        }

        .container { max-width: 1100px; margin: 0 auto; }
        .screen-only { display: block; }
        .print-only { display: none; }

        /* CABE√áALHO */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; background: white; padding: 15px;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .header-title h1 { color: var(--dark); margin: 0; font-size: 1.5rem; }
        .header-title p { color: #666; font-size: 0.8rem; margin: 0; }
        .btn-history {
            background: var(--secondary); color: var(--dark); border: 1px solid var(--primary);
            border-radius: 8px; padding: 10px 15px; font-size: 1.5rem; cursor: pointer;
        }

        .dashboard { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; }
        @media (max-width: 850px) { .dashboard { grid-template-columns: 1fr; } }

        .card {
            background: var(--card-bg); padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        .card-header { font-weight: bold; color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.2rem; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #444; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px;
            box-sizing: border-box; background-color: #fafafa; -webkit-appearance: none;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); background-color: #fff; box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.15); }
        .input-peso { font-weight: bold; color: var(--dark); letter-spacing: 1px; }
        .integer-only { background-color: #fffde7; }

        .result-row { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee; font-size: 1rem; }
        .result-row.negative { color: var(--danger); }

        .highlight-box {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            padding: 20px; border-radius: 12px; text-align: center; margin-top: 25px; border: 1px solid #c5e1a5;
        }
        .highlight-value { font-size: 2.2rem; font-weight: 800; color: var(--dark); line-height: 1.2; }
        .highlight-label { font-size: 0.8rem; color: #558b2f; text-transform: uppercase; font-weight: bold; }

        .actions { margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap; }
        .btn {
            flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 120px;
        }
        .btn-print { background-color: #455a64; }
        .btn-action-conclude { background-color: var(--danger); }
        .btn-action-save { background-color: var(--info); }
        .hidden { display: none; }

        /* MODAIS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .modal-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .modal-title { font-size: 1.4rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .modal-text { color: #666; margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-cancel { background: #eee; color: #333; }
        .btn-confirm-danger { background: var(--danger); color: white; }
        .btn-confirm-success { background: var(--primary); color: white; }

        /* LISTA HIST√ìRICO */
        .list-container { max-height: 60vh; overflow-y: auto; text-align: left; }
        .saved-item {
            background: #f9f9f9; border-left: 5px solid #ccc; padding: 12px; margin-bottom: 10px;
            border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .saved-item.pending { border-left-color: var(--info); background: #e3f2fd; }
        .saved-item.history { border-left-color: var(--primary); background: #e8f5e9; }
        .saved-info strong { display: block; color: #333; font-size: 1rem; }
        .saved-info small { color: #666; font-size: 0.8rem; }
        .saved-details { font-size: 0.75rem; color: #444; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 4px; }
        .delete-btn {
            background: #ffcdd2; color: #c62828; border: none; width: 40px; height: 40px; border-radius: 50%;
            font-weight: bold; cursor: pointer; margin-left: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }

        /* TOAST */
        #installToast {
            position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white;
            padding: 15px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none; align-items: center; gap: 15px; z-index: 2000;
        }
        #installToast button { background: none; border: none; color: #4caf50; font-weight: bold; font-size: 1rem; cursor: pointer; text-transform: uppercase; }
        #installToast .close-toast { color: #aaa; font-size: 1.2rem; margin-left: 10px; cursor: pointer; }

        /* --- IMPRESS√ÉO A5 OTIMIZADA --- */
        @media print {
            @page {
                size: A5 portrait; /* Define papel A5 */
                margin: 0; /* Remove margens do navegador */
            }
            
            body { 
                background-color: white; 
                padding: 0; 
                margin: 0; 
                font-family: 'Arial', sans-serif; 
                color: #000;
                width: 148mm; /* Largura exata A5 */
                height: 210mm; /* Altura exata A5 */
            }
            
            .screen-only { display: none !important; }
            .print-only { display: block !important; }
            
            .receipt-container {
                width: 90%; /* Ocupa 90% da largura do papel */
                margin: 5% auto; /* Centraliza */
                padding: 0;
                box-sizing: border-box;
                page-break-after: always;
            }

            .rec-header { 
                text-align: center; 
                border-bottom: 3px solid #000; 
                padding-bottom: 10px; 
                margin-bottom: 20px; 
            }
            .rec-title { font-size: 18pt; font-weight: 900; text-transform: uppercase; }
            .rec-date { font-size: 12pt; margin-top: 5px; }

            table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            td { padding: 5px 0; vertical-align: bottom; border-bottom: 1px dotted #999; }
            
            .col-label { text-align: left; font-weight: bold; width: 40%; font-size: 12pt; }
            .col-val { text-align: right; width: 60%; font-size: 14pt; }
            
            .section-title {
                font-size: 14pt; font-weight: 900; text-transform: uppercase;
                border-bottom: 2px solid #000; margin-top: 20px; margin-bottom: 10px;
                background-color: #eee !important; -webkit-print-color-adjust: exact;
                padding: 5px;
            }

            .total-box {
                border: 3px solid #000; padding: 15px; margin-top: 20px;
                background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact;
            }
            .total-row { display: flex; justify-content: space-between; align-items: center; }
            .total-big { font-size: 22pt; font-weight: 900; }
            .total-sub { font-size: 16pt; font-weight: bold; }

            .signature-area { margin-top: 50px; text-align: center; font-size: 12pt; }
            .signature-line { border-top: 2px solid #000; width: 100%; margin: 0 auto 5px auto; }
        }
    </style>
</head>
<body>

<!-- TOAST DE INSTALA√á√ÉO -->
<div id="installToast">
    <span>Instalar App?</span>
    <button id="btnInstallConfirm">Instalar</button>
    <span class="close-toast" onclick="document.getElementById('installToast').style.display='none'">&times;</span>
</div>

<!-- MODAL GEN√âRICO -->
<div id="customModal" class="modal-overlay">
    <div class="modal-content">
        <span id="modalIcon" class="modal-icon">‚ö†Ô∏è</span>
        <div id="modalTitle" class="modal-title">Aten√ß√£o</div>
        <div id="modalText" class="modal-text">Mensagem aqui...</div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<!-- MODAL DE HIST√ìRICO -->
<div id="historyModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-title">üìú Hist√≥rico de Pesagens</div>
        <div id="historyList" class="list-container"></div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="btn-modal btn-cancel" onclick="fecharHistorico()">Fechar</button>
        </div>
    </div>
</div>

<!-- CONTE√öDO DA TELA -->
<div class="container screen-only">
    <header>
        <div class="header-title">
            <h1>Romaneio de Gr√£os</h1>
            <p>Sistema de Conting√™ncia Offline</p>
        </div>
        <button class="btn-history" onclick="abrirHistorico()" title="Ver Hist√≥rico">üìú</button>
    </header>

    <div class="dashboard">
        <!-- ESQUERDA -->
        <div class="card">
            <div class="card-header">üìù Dados da Carga</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Produtor *</label>
                    <input type="text" id="produtor" class="nav-input" oninput="verificarEstadoBotao()">
                </div>
                <div class="form-group">
                    <label>Motorista</label>
                    <input type="text" id="motorista" class="nav-input" oninput="verificarEstadoBotao()">
                </div>
            </div>

            <div class="form-group">
                <label>Produto / Cultura</label>
                <select id="produto" class="nav-input" onchange="atualizarInterface()">
                    <option value="soja">üå± SOJA (Base 14%)</option>
                    <option value="milho">üåΩ MILHO (Base 14% - Progressivo)</option>
                    <option value="trigo">üåæ TRIGO (Base 13%)</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Peso Bruto (kg)</label>
                    <input type="tel" id="pesoBruto" class="nav-input input-peso" placeholder="0" onkeyup="mascaraPeso(this); verificarEstadoBotao(); calcular()">
                </div>
                <div class="form-group">
                    <label>Tara (kg)</label>
                    <input type="tel" id="tara" class="nav-input input-peso" placeholder="0" onkeyup="mascaraPeso(this); verificarEstadoBotao(); calcular()">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Umidade (%)</label>
                    <input type="number" id="umidade" class="nav-input" step="0.1" placeholder="0.0" oninput="calcular()">
                </div>
                <div class="form-group">
                    <label>Impureza (%)</label>
                    <input type="number" id="impureza" class="nav-input" step="0.1" placeholder="0.0" oninput="calcular()">
                </div>
            </div>

            <!-- CAMPOS DIN√ÇMICOS -->
            <div id="campos-especificos">
                <div id="spec-soja" class="form-row hidden">
                    <div class="form-group">
                        <label>Ardidos (%)</label>
                        <input type="number" id="soja_ardidos" class="nav-input" step="0.1" oninput="calcular()">
                    </div>
                    <div class="form-group">
                        <label>Esverdeados (%)</label>
                        <input type="number" id="soja_esverdeados" class="nav-input" step="0.1" oninput="calcular()">
                    </div>
                </div>

                <div id="spec-milho" class="form-row hidden">
                    <div class="form-group">
                        <label>Ardidos (%)</label>
                        <input type="number" id="milho_ardidos" class="nav-input" step="0.1" oninput="calcular()">
                    </div>
                    <div class="form-group">
                        <label>Brotados (Inteiro)</label>
                        <input type="number" id="milho_brotados" class="nav-input integer-only" step="1" onchange="forcarInteiro(this)" oninput="calcular()">
                    </div>
                </div>

                <div id="spec-trigo" class="form-row hidden">
                    <div class="form-group">
                        <label>Triguilho (Inteiro)</label>
                        <input type="number" id="trigo_triguilho" class="nav-input integer-only" step="1" onchange="forcarInteiro(this)" oninput="calcular()">
                    </div>
                    <div class="form-group">
                        <label>Gr√£os Brotados (Inteiro)</label>
                        <input type="number" id="trigo_brotados" class="nav-input integer-only" step="1" onchange="forcarInteiro(this)" oninput="calcular()">
                    </div>
                </div>
            </div>
        </div>

        <!-- DIREITA -->
        <div>
            <div class="card">
                <div class="card-header">
                    <span>üìä Resultados</span>
                    <span style="font-size: 0.8rem; font-weight: normal;" id="data-hora"></span>
                </div>

                <div class="result-row">
                    <span>Peso Carga</span>
                    <span style="font-weight: bold;" id="resPesoCarga">0 kg</span>
                </div>
                <div class="result-row">
                    <span>Sacas Brutas</span>
                    <span style="font-weight: bold;" id="resSacasBrutas">0 sc</span>
                </div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <div style="font-size: 0.9rem; color: #777; margin-bottom: 10px;">Descontos:</div>

                <div id="lista-descontos">
                    <div style="text-align: center; color: #999; font-style: italic;">Aguardando dados...</div>
                </div>

                <div class="highlight-box">
                    <div class="highlight-label">PESO L√çQUIDO FINAL</div>
                    <div class="highlight-value" id="resPesoLiquido">0 kg</div>
                    <div style="margin-top: 10px; font-size: 1.5rem; font-weight: bold; color: var(--dark);">
                        <span id="resSacasLiquidas">0</span> Sacas
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-print" onclick="abrirModalImpressao()">üñ®Ô∏è Imprimir</button>
                    <button id="btnAction" class="btn btn-action-save" onclick="salvarTemporario()">üíæ Salvar Temp.</button>
                </div>
            </div>

            <!-- LISTA DE CARGAS PENDENTES -->
            <div id="cardPendentes" class="card hidden">
                <div class="card-header">üíæ Cargas Pendentes</div>
                <div id="listaSalvos"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE QUANTIDADE DE C√ìPIAS -->
<div id="modalPrint" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">Imprimir Romaneio</div>
        <p>Quantas c√≥pias deseja?</p>
        <input type="number" id="qtdCopias" value="1" min="1" max="5" style="font-size: 1.5rem; text-align: center; width: 80px; margin-bottom: 20px;">
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="fecharModalImpressao()">Cancelar</button>
            <button class="btn-modal btn-confirm-success" onclick="confirmarImpressao()">IMPRIMIR</button>
        </div>
    </div>
</div>

<!-- √ÅREA DE IMPRESS√ÉO -->
<div id="print-area" class="print-only"></div>

<script>
    // --- L√ìGICA DE INSTALA√á√ÉO PWA ---
    let deferredPrompt;
    const installToast = document.getElementById('installToast');
    const btnInstallConfirm = document.getElementById('btnInstallConfirm');

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js');
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installToast.style.display = 'flex';
    });

    btnInstallConfirm.addEventListener('click', () => {
        installToast.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            deferredPrompt = null;
        });
    });

    // --- VARI√ÅVEIS GLOBAIS ---
    let idEdicaoAtual = null;
    let dadosImpressao = {};

    const regras = {
        soja: { umidadeBase: 14.0, ardidosBase: 8.0, esverdeadosBase: 8.0 },
        milho: { umidadeBase: 14.0, ardidosBase: 6.0 },
        trigo: { umidadeBase: 13.0 }
    };

    // --- MODAIS ---
    function showModal(icon, title, text, buttons) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalIcon').innerText = icon;
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalText').innerText = text;
        const actionsDiv = document.getElementById('modalActions');
        actionsDiv.innerHTML = '';
        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = `btn-modal ${btn.class}`;
            button.innerText = btn.text;
            button.onclick = () => { modal.style.display = 'none'; if (btn.action) btn.action(); };
            actionsDiv.appendChild(button);
        });
        modal.style.display = 'flex';
    }
    function showAlert(title, text) { showModal('‚ÑπÔ∏è', title, text, [{ text: 'OK', class: 'btn-confirm-success' }]); }
    function showConfirm(title, text, onConfirm, isDanger = false) {
        showModal(isDanger ? 'üóëÔ∏è' : '‚ùì', title, text, [
            { text: 'Cancelar', class: 'btn-cancel' },
            { text: 'Confirmar', class: isDanger ? 'btn-confirm-danger' : 'btn-confirm-success', action: onConfirm }
        ]);
    }

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        renderizarListaSalvos();
        atualizarInterface();
        verificarEstadoBotao();
        const inputs = document.querySelectorAll('.nav-input');
        inputs.forEach((input, index) => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextInput = inputs[index + 1];
                    if (nextInput && !nextInput.parentElement.parentElement.classList.contains('hidden')) {
                        nextInput.focus();
                    }
                }
            });
        });
    });

    // --- L√ìGICA DE BOT√ÉO ---
    function verificarEstadoBotao() {
        const bruto = getPesoLimpo('pesoBruto');
        const tara = getPesoLimpo('tara');
        const btn = document.getElementById('btnAction');
        if (bruto > 0 && tara > 0) {
            btn.innerText = "üîÑ Concluir";
            btn.className = "btn btn-action-conclude";
            btn.onclick = concluirPesagem;
        } else {
            btn.innerText = "üíæ Salvar Temp.";
            btn.className = "btn btn-action-save";
            btn.onclick = salvarTemporario;
        }
    }

    function salvarTemporario() {
        const produtor = document.getElementById('produtor').value.trim();
        const motorista = document.getElementById('motorista').value.trim();
        if (!produtor && !motorista) { showAlert("Falta Identifica√ß√£o", "Para salvar, informe o Nome do Produtor ou Motorista."); return; }
        
        const dados = capturarDadosFormulario();
        dados.id = idEdicaoAtual || Date.now();
        dados.timestamp = new Date().toLocaleString();

        let salvos = JSON.parse(localStorage.getItem('cargasPendentes') || '[]');
        if (idEdicaoAtual) salvos = salvos.filter(item => item.id !== idEdicaoAtual);
        salvos.push(dados);
        localStorage.setItem('cargasPendentes', JSON.stringify(salvos));

        showAlert("Sucesso", "Carga salva temporariamente!");
        limparFormulario();
        renderizarListaSalvos();
    }

    function concluirPesagem() {
        showConfirm("Concluir Pesagem?", "Isso finalizar√° o romaneio e salvar√° no hist√≥rico.", () => {
            // For√ßa c√°lculo para garantir dados atualizados
            calcular();
            
            const dados = capturarDadosFormulario();
            dados.id = Date.now();
            dados.timestamp = new Date().toLocaleString();
            // Salva o objeto de impress√£o atual (que foi atualizado pelo calcular())
            dados.resultados = JSON.parse(JSON.stringify(dadosImpressao)); 

            let historico = JSON.parse(localStorage.getItem('historicoPesagens') || '[]');
            historico.unshift(dados);
            localStorage.setItem('historicoPesagens', JSON.stringify(historico));

            if (idEdicaoAtual) {
                let salvos = JSON.parse(localStorage.getItem('cargasPendentes') || '[]');
                salvos = salvos.filter(item => item.id !== idEdicaoAtual);
                localStorage.setItem('cargasPendentes', JSON.stringify(salvos));
            }
            
            limparFormulario();
            renderizarListaSalvos();
            window.scrollTo(0, 0);
        });
    }

    // --- HIST√ìRICO ---
    function abrirHistorico() {
        const historico = JSON.parse(localStorage.getItem('historicoPesagens') || '[]');
        const container = document.getElementById('historyList');
        container.innerHTML = '';

        if (historico.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Nenhuma pesagem conclu√≠da.</div>';
        } else {
            historico.forEach(item => {
                const div = document.createElement('div');
                div.className = 'saved-item history';
                
                // Dados seguros
                const res = item.resultados || {};
                const bruto = res.bruto || 0;
                const sacasBrutas = res.sacasBrutas || 0;
                const liquido = res.pesoFinal || 0;
                const sacasLiquidas = res.sacasFinais || 0;

                div.innerHTML = `
                    <div style="flex:1">
                        <strong>${item.produtor}</strong>
                        <small>${item.produto.toUpperCase()} - ${item.timestamp}</small>
                        <div class="saved-details">
                            Bruto: ${formatKg(bruto)} kg (${sacasBrutas} sc)<br>
                            L√≠q: <b>${formatKg(liquido)} kg (${sacasLiquidas} sc)</b>
                        </div>
                    </div>
                    <button class="btn-history" style="font-size:1rem; padding:5px 10px;" onclick="reimprimirHistorico(${item.id})">üñ®Ô∏è</button>
                `;
                container.appendChild(div);
            });
        }
        document.getElementById('historyModal').style.display = 'flex';
    }

    function fecharHistorico() { document.getElementById('historyModal').style.display = 'none'; }

    function reimprimirHistorico(id) {
        const historico = JSON.parse(localStorage.getItem('historicoPesagens') || '[]');
        const item = historico.find(i => i.id === id);
        if (item && item.resultados) {
            dadosImpressao = item.resultados;
            fecharHistorico();
            abrirModalImpressao();
        } else {
            showAlert("Erro", "Dados de impress√£o corrompidos ou antigos.");
        }
    }

    // --- LISTA DE PENDENTES ---
    function renderizarListaSalvos() {
        const salvos = JSON.parse(localStorage.getItem('cargasPendentes') || '[]');
        const container = document.getElementById('listaSalvos');
        const card = document.getElementById('cardPendentes');
        container.innerHTML = '';

        if (salvos.length === 0) { card.classList.add('hidden'); return; }
        card.classList.remove('hidden');
        
        salvos.forEach(item => {
            const div = document.createElement('div');
            div.className = 'saved-item pending';
            let infoPeso = '';
            if (item.pesoBruto) infoPeso = `Bruto: ${item.pesoBruto}`;
            if (item.tara) infoPeso = `Tara: ${item.tara}`;

            div.innerHTML = `
                <div class="saved-content" onclick="carregarSalvo(${item.id})" style="flex:1">
                    <div class="saved-info">
                        <strong>${item.produtor || item.motorista || 'Sem Nome'}</strong>
                        <small>${item.produto.toUpperCase()} - ${item.timestamp}</small>
                    </div>
                    <div class="saved-badge">${infoPeso}</div>
                </div>
                <button class="delete-btn" onclick="excluirSalvo(${item.id})">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        });
    }

    function excluirSalvo(id) {
        showConfirm("Excluir Carga?", "Essa a√ß√£o n√£o pode ser desfeita.", () => {
            let salvos = JSON.parse(localStorage.getItem('cargasPendentes') || '[]');
            salvos = salvos.filter(item => item.id !== id);
            localStorage.setItem('cargasPendentes', JSON.stringify(salvos));
            renderizarListaSalvos();
        }, true);
    }

    function carregarSalvo(id) {
        const salvos = JSON.parse(localStorage.getItem('cargasPendentes') || '[]');
        const item = salvos.find(i => i.id === id);
        if(!item) return;
        idEdicaoAtual = item.id;
        
        document.getElementById('produtor').value = item.produtor;
        document.getElementById('motorista').value = item.motorista;
        document.getElementById('produto').value = item.produto;
        document.getElementById('pesoBruto').value = item.pesoBruto;
        document.getElementById('tara').value = item.tara;
        document.getElementById('umidade').value = item.umidade;
        document.getElementById('impureza').value = item.impureza;
        document.getElementById('soja_ardidos').value = item.soja_ardidos;
        document.getElementById('soja_esverdeados').value = item.soja_esverdeados;
        document.getElementById('milho_ardidos').value = item.milho_ardidos;
        document.getElementById('milho_brotados').value = item.milho_brotados;
        document.getElementById('trigo_triguilho').value = item.trigo_triguilho;
        document.getElementById('trigo_brotados').value = item.trigo_brotados;

        atualizarInterface();
        verificarEstadoBotao();
        window.scrollTo(0, 0);
    }

    function capturarDadosFormulario() {
        return {
            produtor: document.getElementById('produtor').value,
            motorista: document.getElementById('motorista').value,
            produto: document.getElementById('produto').value,
            pesoBruto: document.getElementById('pesoBruto').value,
            tara: document.getElementById('tara').value,
            umidade: document.getElementById('umidade').value,
            impureza: document.getElementById('impureza').value,
            soja_ardidos: document.getElementById('soja_ardidos').value,
            soja_esverdeados: document.getElementById('soja_esverdeados').value,
            milho_ardidos: document.getElementById('milho_ardidos').value,
            milho_brotados: document.getElementById('milho_brotados').value,
            trigo_triguilho: document.getElementById('trigo_triguilho').value,
            trigo_brotados: document.getElementById('trigo_brotados').value
        };
    }

    function limparFormulario() {
        document.querySelectorAll('input').forEach(input => input.value = '');
        document.getElementById('produto').selectedIndex = 0;
        idEdicaoAtual = null;
        atualizarInterface();
        verificarEstadoBotao();
        document.getElementById('resPesoCarga').innerText = '0 kg';
        document.getElementById('resSacasBrutas').innerText = '0 sc';
        document.getElementById('resPesoLiquido').innerText = '0 kg';
        document.getElementById('resSacasLiquidas').innerText = '0';
        document.getElementById('lista-descontos').innerHTML = '<div style="text-align:center; color:#999;">Aguardando dados...</div>';
    }

    // --- FUN√á√ïES AUXILIARES ---
    function mascaraPeso(input) {
        let valor = input.value.replace(/\D/g, "");
        valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        input.value = valor;
    }
    function getPesoLimpo(id) {
        const raw = document.getElementById(id).value;
        const clean = raw.replace(/\./g, '').replace(/,/g, ''); 
        return parseInt(clean) || 0;
    }
    function getFloat(id) {
        let val = document.getElementById(id).value;
        if (!val) return 0;
        val = val.replace(',', '.');
        return parseFloat(val) || 0;
    }
    function forcarInteiro(input) { input.value = Math.floor(input.value); }
    function formatKg(num) { return num.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
    function formatDec(num) { return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function atualizarInterface() {
        const produto = document.getElementById('produto').value;
        ['spec-soja', 'spec-milho', 'spec-trigo'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('spec-' + produto).classList.remove('hidden');
        const agora = new Date();
        document.getElementById('data-hora').innerText = agora.toLocaleDateString() + ' ' + agora.toLocaleTimeString().slice(0,5);
        calcular();
    }

    function calcular() {
        const produto = document.getElementById('produto').value;
        const pesoBruto = getPesoLimpo('pesoBruto');
        const tara = getPesoLimpo('tara');
        
        let pesoCarga = pesoBruto - tara;
        if (pesoCarga < 0) pesoCarga = 0;

        let listaDescontos = [];
        let totalKgDesconto = 0;

        const impurezaPerc = getFloat('impureza');
        if (impurezaPerc > 0) {
            const descKg = pesoCarga * (impurezaPerc / 100);
            listaDescontos.push({ nome: "Impureza", perc: impurezaPerc, kg: descKg });
            totalKgDesconto += descKg;
        }

        const umidadeVal = getFloat('umidade');
        const regra = regras[produto];
        
        if (umidadeVal > regra.umidadeBase) {
            const excedente = umidadeVal - regra.umidadeBase;
            let percDesconto = 0;

            if (produto === 'milho') {
                if (umidadeVal <= 24.8) { percDesconto = excedente * 1.75; } 
                else { percDesconto = (excedente * 2.0) - 2.7; }
            } 
            else if (produto === 'soja') {
                if (umidadeVal <= 14.5) { percDesconto = excedente * 1.60; } 
                else if (umidadeVal <= 26.0) { percDesconto = excedente * 1.65; } 
                else { percDesconto = excedente * 3.25; }
            }
            else if (produto === 'trigo') { percDesconto = excedente * 1.75; }

            const descKg = pesoCarga * (percDesconto / 100);
            listaDescontos.push({ nome: `Umidade`, perc: percDesconto, kg: descKg });
            totalKgDesconto += descKg;
        }

        if (produto === 'soja') {
            const ardidos = getFloat('soja_ardidos');
            if (ardidos > regra.ardidosBase) {
                const perc = ardidos - regra.ardidosBase;
                const kg = pesoCarga * (perc / 100);
                listaDescontos.push({ nome: `Ardidos`, perc: perc, kg: kg });
                totalKgDesconto += kg;
            }
            const esverdeados = getFloat('soja_esverdeados');
            if (esverdeados > regra.esverdeadosBase) {
                const perc = esverdeados - regra.esverdeadosBase;
                const kg = pesoCarga * (perc / 100);
                listaDescontos.push({ nome: `Esverdeados`, perc: perc, kg: kg });
                totalKgDesconto += kg;
            }
        }

        if (produto === 'milho') {
            const ardidos = getFloat('milho_ardidos');
            if (ardidos > regra.ardidosBase) {
                const perc = ardidos - regra.ardidosBase;
                const kg = pesoCarga * (perc / 100);
                listaDescontos.push({ nome: `Ardidos`, perc: perc, kg: kg });
                totalKgDesconto += kg;
            }
            const brotados = Math.floor(getFloat('milho_brotados'));
            if (brotados > 0) {
                const kg = pesoCarga * (brotados / 100);
                listaDescontos.push({ nome: "Brotados", perc: brotados, kg: kg });
                totalKgDesconto += kg;
            }
        }

        if (produto === 'trigo') {
            const triguilho = Math.floor(getFloat('trigo_triguilho'));
            if (triguilho > 0) {
                const kg = pesoCarga * (triguilho / 100);
                listaDescontos.push({ nome: "Triguilho", perc: triguilho, kg: kg });
                totalKgDesconto += kg;
            }
            const brotados = Math.floor(getFloat('trigo_brotados'));
            if (brotados > 0) {
                const kg = pesoCarga * (brotados / 100);
                listaDescontos.push({ nome: "Gr√£os Brotados", perc: brotados, kg: kg });
                totalKgDesconto += kg;
            }
        }

        const pesoLiquido = pesoCarga - totalKgDesconto;
        const sacasBrutas = Math.round(pesoCarga / 60);
        const sacasLiquidas = Math.round(pesoLiquido / 60);

        document.getElementById('resPesoCarga').innerText = formatKg(pesoCarga) + ' kg';
        document.getElementById('resSacasBrutas').innerText = sacasBrutas + ' sc';
        document.getElementById('resPesoLiquido').innerText = formatKg(pesoLiquido) + ' kg';
        document.getElementById('resSacasLiquidas').innerText = sacasLiquidas;

        const containerLista = document.getElementById('lista-descontos');
        containerLista.innerHTML = '';
        if (listaDescontos.length === 0) {
            containerLista.innerHTML = '<div style="text-align:center; color:#999;">Nenhum desconto aplicado.</div>';
        } else {
            listaDescontos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-row negative';
                div.innerHTML = `<span>${item.nome} <small>(${formatDec(item.perc)}%)</small></span><span>- ${formatKg(item.kg)} kg</span>`;
                containerLista.appendChild(div);
            });
        }

        // ATUALIZA√á√ÉO CR√çTICA: Salva os dados calculados para impress√£o
        dadosImpressao = {
            produtor: document.getElementById('produtor').value || '---',
            motorista: document.getElementById('motorista').value || '---',
            produto: produto.toUpperCase(),
            bruto: pesoBruto,
            tara: tara,
            liquido: pesoCarga,
            sacasBrutas: sacasBrutas,
            descontos: listaDescontos,
            pesoFinal: pesoLiquido,
            sacasFinais: sacasLiquidas,
            data: document.getElementById('data-hora').innerText
        };
    }

    function abrirModalImpressao() {
        calcular();
        document.getElementById('modalPrint').style.display = 'flex';
        document.getElementById('qtdCopias').focus();
    }

    function fecharModalImpressao() { document.getElementById('modalPrint').style.display = 'none'; }

    function confirmarImpressao() {
        const qtd = parseInt(document.getElementById('qtdCopias').value) || 1;
        gerarHTMLImpressao(qtd);
        fecharModalImpressao();
        window.print();
    }

    function gerarHTMLImpressao(copias) {
        const area = document.getElementById('print-area');
        area.innerHTML = '';

        const template = `
            <div class="receipt-container">
                <div class="rec-header">
                    <div class="rec-title">ROMANEIO DE CLASSIFICA√á√ÉO</div>
                    <div class="rec-date">${dadosImpressao.data}</div>
                </div>
                
                <table>
                    <tr><td class="col-label">PRODUTOR:</td><td class="col-val" style="text-align:left">${dadosImpressao.produtor}</td></tr>
                    <tr><td class="col-label">MOTORISTA:</td><td class="col-val" style="text-align:left">${dadosImpressao.motorista}</td></tr>
                    <tr><td class="col-label">PRODUTO:</td><td class="col-val" style="text-align:left">${dadosImpressao.produto}</td></tr>
                </table>
                
                <div class="section-title">PESAGEM</div>
                <table>
                    <tr><td class="col-label">PESO BRUTO:</td><td class="col-val">${formatKg(dadosImpressao.bruto)} kg</td></tr>
                    <tr><td class="col-label">TARA:</td><td class="col-val">${formatKg(dadosImpressao.tara)} kg</td></tr>
                    <tr><td class="col-label" style="font-size:1.1em">PESO CARGA:</td><td class="col-val" style="font-weight:bold; font-size:1.1em">${formatKg(dadosImpressao.liquido)} kg</td></tr>
                    <tr><td class="col-label">SACAS BRUTAS:</td><td class="col-val">${dadosImpressao.sacasBrutas} sc</td></tr>
                </table>
                
                <div class="section-title">DESCONTOS</div>
                <table>
                    ${dadosImpressao.descontos.length === 0 ? '<tr><td colspan="2" style="text-align:center">- Sem Descontos -</td></tr>' : ''}
                    ${dadosImpressao.descontos.map(d => `
                        <tr>
                            <td class="col-label" style="font-weight:normal">${d.nome} (${formatDec(d.perc)}%)</td>
                            <td class="col-val">- ${formatKg(d.kg)} kg</td>
                        </tr>
                    `).join('')}
                </table>
                
                <div class="total-box">
                    <div class="total-row">
                        <span class="total-sub">L√çQUIDO:</span>
                        <span class="total-sub" style="font-weight:bold">${formatKg(dadosImpressao.pesoFinal)} kg</span>
                    </div>
                    <div class="total-row" style="margin-top:5px">
                        <span class="total-big">TOTAL:</span>
                        <span class="total-big">${dadosImpressao.sacasFinais} SACAS</span>
                    </div>
                </div>
                
                <div class="signature-area">
                    <div class="signature-line"></div>
                    Assinatura do Respons√°vel / Classificador
                </div>
            </div>
        `;

        for (let i = 0; i < copias; i++) {
            area.innerHTML += template;
        }
    }
</script>

</body>
</html>
